# Charts analyser: web-service

Веб-сервис для мониторинга и анализа трэков судов и их соответствия
границам морских карт


## Запуск

Перед запуском необходимо подготовить импортируемые данные, см Импорт данных 

Запуск приложений с помощью docker composer
```sh
docker composer up
```
Первый запуск может длиться продолжительное время - в зависимости от количества импортируемых данных

## Импорт данных

По умолчанию, определены следующие папки
- `./data` - папка для файлов импорта
 Для импортирования данных зон и исторических треков, необходимо положить файл зон `geo_zones.json` в корень папки импорта. Формат файла: JSON массив с названиями зон в ключах и полигонами координат в значениях.
  При импорте предусмотрено исправление координат полигонов - если первая и последняя координаты не одинаковы - добавляется завершающая координата полигона
- `./data/tracks` - папка для набора треков - файлы *.csv с полями
  `timestamp,longitude,latitude,vessel_id,vessel_name`  


## Функциональность серверной части

#### Авторизация

Все роуты серверной части ограничены проверкой JWT токена. 
В токене должна быть указана роль  

<details><summary>Click to expand</summary>

```json
{
  "id": "9233466",
  "name": "Saga Viking",
  "role": 1
}
```

</details>

- роль `1` для судна - POST `api/track` 
- pоль `2` для оператора - остальные роуты

#### API

- GET `/api/zones` - список морских карт, которые пересекались
заданными в запросе судами в заданный временной промежуток. Входные параметры:
идентификаторы судов, стартовая дата, конечная дата. JSON в теле запроса
  <details><summary>Click to expand</summary>

  ```json
  {
   "vesselIDs": [
    8902967
   ],
   "start": "2017-10-12T00:00:11Z",
   "finish": "2017-10-13T00:00:11Z"
  }
  ```
  </details>  

- GET `api/vessels` список судов, которые пересекали заданные в
запросе морские карты в заданный временной промежуток. Входные параметры:
идентификатор карт, стартовая дата, конечная дата. JSON в теле запроса
  <details><summary>Click to expand</summary>

  ```json
  {
   "zoneNames": [
    "zone_205"
   ],
   "start": "2017-01-08T00:00:00Z",
   "finish": "2017-01-09T00:00:00Z"
  }
  ```
  </details>  
- GET `api/monitor` - список судов, поставленных на мониторинг. 
- POST `api/monitor` - поставить суда на мониторинг. JSON Массив ID в теле запроса 
- DELETE `api/monitor` - снять суда с мониторинга. JSON Массив ID в теле запроса
- GET `api/monitor/state` - подробная информация для судов, стоящих на мониторинге  
  Включающая: 
  - Для поставки судна на мониторинг и снятия с него 
  - Имя карты, которую судно пересекает в данный момент.
  - Время, проведенное судном на мониторинге в текущей зоне (карте). Время
  отсчитывается с момента последнего пересечения границы зоны судном (момент
  входа в зону). 
- POST `api/track` отправка трека судном. Запись в историю и отображение в мониторинге, если судно стоит на контроле. ID судна берется из JWT, исключая возможность ошибочной записи чужого трека
- GET `api/track/:id` список треков за указанный период ждя судна

## Ограничения
Сервис принимает треки только в следующих географических координатах:
- min_longitude = -180.0
- max_longitude = 180.0
- min_latitude = -75.0
- max_latitude = 75.0

## Симулятор

Симулятор потока реальных данных, который базируется на предоставленных
исторических данных.

Берет из истории несколько случайных судов, ставит их на контроль (`/api/monitor`) 
с токеном оператора, затем, с заданной периодичностью отправляет уже имеющиеся в базе треки с токеном судна (POST `/api/track`)

Может работать в режиме реального времени - отправляя трек в исторические часы, минуты.
По умолчанию отправляет треки раз в 10 сек.

